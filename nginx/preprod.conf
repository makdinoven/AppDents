# ===================== preprod.conf (test.dent-s.com) =====================

# внутренняя DNS Docker
resolver 127.0.0.11 ipv6=off valid=5s;

# правильная поддержка WebSocket/HTTP2 upgrade
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# скрыть версию nginx
server_tokens off;

# upstream-ы из docker-compose
upstream backend  { server backend:8000;  keepalive 16; }
upstream frontend { server frontend:80;   keepalive 16; }
upstream adminer  { server adminer:8080;  keepalive 4;  }

# базовая оптимизация
gzip on;
gzip_comp_level 5;
gzip_min_length 256;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss image/svg+xml;

# --------------------------- HTTP :80 (ACME + редирект) -------------------
server {
    listen 80;
    server_name test.dent-s.com;
    client_max_body_size 100M;

    # ACME webroot для certbot (renew)
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
        default_type "text/plain";
    }

    return 301 https://$host$request_uri;
}

# --------------------------- HTTPS :443 -----------------------------------
server {
    listen 443 ssl;
    http2 on;
    server_name test.dent-s.com;
    client_max_body_size 100M;

    # TLS (пути из тома certbot-etc)
    ssl_certificate     /etc/letsencrypt/live/test.dent-s.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/test.dent-s.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # Включи HSTS после проверки HTTPS (закомментировано для безопасности на первых порах)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Нужные заголовки безопасности
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;

    # Общие proxy-настройки
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_connect_timeout 60s;
    proxy_send_timeout    300s;
    proxy_read_timeout    300s;
    send_timeout          300s;

    # -------- Stripe webhook
    location /api/stripe/webhook/ {
        proxy_pass http://backend/api/stripe/webhook/;
        access_log  /var/log/nginx/stripe_webhook.log;
        error_log   /var/log/nginx/stripe_webhook.error.log;
    }

    # -------- API
    location /api/ {
        proxy_pass http://backend/api/;
    }

    # -------- Adminer
    location /adminer/ {
        proxy_pass http://adminer/;
    }

    # -------- Docs / OpenAPI / Redoc
    location /openapi.json { proxy_pass http://backend/openapi.json; }
    location /redoc        { proxy_pass http://backend/redoc; }
    location /docs         { proxy_pass http://backend; }

    # -------- Предпросмотр картинок c хоста
    location /assets/img/preview_img/ {
        alias /assets/img/preview_img/;
        autoindex on;
        # кэш для медиа (можно убрать при необходимости)
        expires 1h;
    }

    # -------- Статика SPA (проксируем во фронтенд-контейнер)
    location / {
        proxy_pass http://frontend;
    }

    # (опционально) агрессивный кэш для статических расширений
    location ~* \.(?:js|mjs|css|svg|png|jpe?g|webp|gif|ico|woff2?)$ {
        proxy_pass http://frontend;
        expires 7d;
        add_header Cache-Control "public, max-age=604800, immutable";
    }
}
# ========================================================================
