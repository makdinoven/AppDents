FROM python:3.12-slim

ARG DEBIAN_FRONTEND=noninteractive

# 1) –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã (–∫–∞–∫ —É —Ç–µ–±—è) + –¥–æ–ø. –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–π –∏ OCR
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libmariadb-dev-compat libmariadb-dev \
    ffmpeg ghostscript wget xz-utils ca-certificates \
    # –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ/Qt deps –¥–ª—è Calibre GUI-–±–∏–±–ª–∏–æ—Ç–µ–∫, –Ω—É–∂–Ω—ã—Ö –µ–≥–æ CLI
    libegl1 libopengl0 libgl1 \
    libxkbcommon0 libxcomposite1 libxrandr2 libxdamage1 libxfixes3 \
    libxcb1 libxext6 libxi6 libx11-6 libx11-xcb1 \
    libglib2.0-0 libnss3 libnspr4 \
    libdrm2 libgbm1 libxshmfence1 \
    libfontconfig1 libxrender1 libsm6 \
    fonts-dejavu-core fonts-liberation \
    libharfbuzz0b libpng16-16 \
    libxcb-cursor0 libxkbcommon-x11-0 \
    # üîπ –ù–û–í–û–ï: —Å—Ç–µ–∫ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–π –∏ OCR
    qpdf mupdf-tools \            # qpdf + mutool (–¥–ª—è clean/linearize)
    ocrmypdf \                    # —Å–∞–º OCR-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
    tesseract-ocr tesseract-ocr-eng tesseract-ocr-rus \  # –¥–≤–∏–∂–æ–∫ –∏ —è–∑—ã–∫–∏
    pngquant unpaper \            # —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∏ –∞–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
 && rm -rf /var/lib/apt/lists/*

# 2) –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Calibre (–∫–∞–∫ —É —Ç–µ–±—è)
RUN wget -nv -O- https://download.calibre-ebook.com/linux-installer.sh | sh /dev/stdin

# 3) –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ—Ä—Å–∏–π (–≤–∞–∂–Ω–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
RUN /opt/calibre/ebook-convert --version \
 && ocrmypdf --version \
 && tesseract --version \
 && qpdf --version \
 && mutool -v

# 4) ENV –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ Calibre/OCR
ENV PATH="/opt/calibre:${PATH}"
ENV EBOOK_CONVERT_BIN="/opt/calibre/ebook-convert"
ENV CALIBRE_NO_NATIVE_FILEDIALOG=1
ENV PYTHONUNBUFFERED=1

# üîπ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–∞—à–µ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ (–º–æ–∂–µ—à—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –≤ compose)
# ‚Äî –≤–∫–ª—é—á–∞–µ–º OCR-–≤—Å—Ç–∞–≤–∫—É (–ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ OCR-–≤–µ—Ç–∫–µ, –µ—Å–ª–∏ PDF ‚Äî —Å–∫–∞–Ω)
ENV CALIBRE_ENABLE_OCR=1
ENV OCR_LANGS="eng+rus"
# ‚Äî –Ω–∞–±–æ—Ä —Ñ–ª–∞–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –≤ –∫–æ–¥–µ
ENV OCR_OPTS="--skip-text --rotate-pages --deskew --clean-final --optimize 3"

# ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–µ—Ñ–ª–∞–π—Ç–∞ –∏ —Å—Ç–æ—Ä–æ–∂–µ–π (—Ä–∞–≤–Ω—ã —Ç–µ–º, —á—Ç–æ —É —Ç–µ–±—è –≤ –∫–æ–¥–µ/ENV)
ENV CALIBRE_PDF_PREFLIGHT_STRATEGY="gs,mutool,qpdf"
ENV CALIBRE_STALL_NO_OUTPUT_SECS="1000"
ENV CALIBRE_STALL_NO_PROGRESS_SECS="2600"
ENV CALIBRE_MAX_STAGE_SECS="5400"
ENV CALIBRE_PROGRESS_HEARTBEAT="60"
ENV CALIBRE_CONVERT_LOG_LEVEL="INFO"

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
