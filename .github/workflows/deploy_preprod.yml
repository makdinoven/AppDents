name: üöÄ Deploy to Preprod

# —Ç—Ä–∏–≥–≥–µ—Ä –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É preprod
on:
  push:
    branches: [ "preprod" ]

jobs:
  # 1) –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_services: ${{ steps.prepare.outputs.changed_services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Detect changed folders
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            nginx:
              - 'nginx/**'

      - name: Prepare changed_services output
        id: prepare
        run: |
          SERVICES=""
          if [ "${{ steps.changes.outputs.backend }}" = "true" ]; then
            SERVICES="$SERVICES backend"
          fi
          if [ "${{ steps.changes.outputs.frontend }}" = "true" ]; then
            SERVICES="$SERVICES frontend"
          fi
          if [ "${{ steps.changes.outputs.nginx }}" = "true" ]; then
            SERVICES="$SERVICES nginx"
          fi
          echo "changed_services=$SERVICES" >> $GITHUB_OUTPUT

  # 2) –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–µ–ø—Ä–æ–¥-—Å–µ—Ä–≤–µ—Ä
  deploy:
    name: SSH Deploy to Preprod
    runs-on: ubuntu-latest
    needs: check-changes
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Load SSH key
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.PREPROD_SERVER_SSH_KEY }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PREPROD_SERVER_HOST }}
          username: ${{ secrets.PREPROD_SERVER_USER }}
          skip_host_key_check: true
          script: |
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–µ–ø—Ä–æ–¥–∞
            cd /var/www/AppDents-preprod

            # –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–µ—Ç–∫—É –∏ —Ç—è–Ω–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            git fetch origin
            git checkout preprod
            git pull --no-rebase -s recursive -X theirs origin preprod

            # –∑–∞–¥–∞—ë–º –ø—Ä–æ–µ–∫—Ç –∏ —Ñ–∞–π–ª—ã compose
            export COMPOSE_PROJECT_NAME=appdents_preprod
            COMPOSE_FILES="-f docker-compose.yml -f docker-compose.preprod.yaml"

            # —Å–æ–±–∏—Ä–∞–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (–µ—Å–ª–∏ –±—ã–ª–∏)
            CHANGED="${{ needs.check-changes.outputs.changed_services }}"
            if [ -n "$CHANGED" ]; then
              echo "Changed services: $CHANGED"
              docker compose $COMPOSE_FILES build $CHANGED
            else
              echo "No service changes ‚Äî skipping selective build"
            fi

            # nginx –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º
            docker compose $COMPOSE_FILES build nginx

            # –≤—ã–∫–∞—Ç—ã–≤–∞–µ–º
            docker compose $COMPOSE_FILES up -d

            # –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
            docker compose $COMPOSE_FILES exec nginx nginx -s reload

            # —á–∏—Å—Ç–∏–º –±–∏–ª–¥-–∫–µ—à
            docker builder prune -f
