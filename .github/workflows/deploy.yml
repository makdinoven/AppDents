name: Deploy to Production

on:
  push:
    branches: [ "main" ]

concurrency:
  group: prod-deploy
  cancel-in-progress: true

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_services: ${{ steps.prepare.outputs.changed_services }}
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Detect changed folders
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            nginx:
              - 'nginx/**'

      - name: Prepare changed_services output
        id: prepare
        run: |
          SERVICES=""
          if [ "${{ steps.changes.outputs.backend }}" = "true" ]; then
            SERVICES="$SERVICES backend"
          fi
          if [ "${{ steps.changes.outputs.frontend }}" = "true" ]; then
            SERVICES="$SERVICES frontend"
          fi
          if [ "${{ steps.changes.outputs.nginx }}" = "true" ]; then
            SERVICES="$SERVICES nginx"
          fi
          echo "changed_services=$SERVICES" >> "$GITHUB_OUTPUT"

  deploy:
    runs-on: ubuntu-latest
    needs: [check-changes]
    steps:
      - uses: actions/checkout@v3

      - name: SSH Deploy
        uses: appleboy/ssh-action@v1.2.0
        env:
          CHANGED_SERVICES: ${{ needs.check-changes.outputs.changed_services }}
        with:
          host: ${{ secrets.TW_SERVER_HOST }}
          username: ${{ secrets.TW_SERVER_USER }}
          key: ${{ secrets.TW_SERVER_SSH_KEY }}
          port: 22
          script_stop: true
          debug: true
          envs: CHANGED_SERVICES
          script: |
            set -Eeuo pipefail
            set -x

            cd /var/www/AppDents
            export COMPOSE_PROJECT_NAME=appdents

            git config --local core.hooksPath /dev/null

            echo "[git] sync to origin/main (hooks disabled)"
            git fetch --prune origin main
            git reset --hard origin/main

            CHANGED="$(echo "${CHANGED_SERVICES:-}" | xargs)"   # обрежем пробелы

            if [ "$CHANGED" = "" ]; then
              echo "Нет изменений в сервисах — пересобираем только nginx"
              sudo docker compose build nginx
            else
              echo "Есть изменения в: $CHANGED"
              sudo docker compose build $CHANGED nginx
            fi

            sudo docker compose up -d
            sudo docker compose exec nginx nginx -s reload || sudo docker compose restart nginx
            sudo docker builder prune -f
